document.addEventListener("DOMContentLoaded",function(){const v=document.getElementById("filterForm"),M=document.getElementById("mobileFilterForm"),b=document.getElementById("coursesWrapper"),d=document.getElementById("coursesContainer");let u=1,i=!1,a=!0,m={},h="/courses";q();function q(){x(),F(),$(),R()}function x(){const o=window.location.pathname,s=new URLSearchParams(window.location.search);h=o==="/courses"?"/courses":o;const l=s.get("keyword");l&&(h=`/courses?keyword=${encodeURIComponent(l)}`);const n={};for(const[e,t]of s.entries())e!=="page"&&t&&(n[e]=t);if(Object.keys(n).length===0){const e=v||M;if(e){const t=new FormData(e);for(const[r,c]of t.entries())c&&(n[r]=c)}}m=n,console.log("üîß Initial state:",{currentBaseUrl:h,currentFilters:m})}function F(){[v,M].filter(s=>s).forEach(s=>{s.addEventListener("submit",function(e){e.preventDefault(),k(s)}),s.querySelectorAll("select.filter-input").forEach(e=>{e.addEventListener("change",function(){k(s)})});const n=s.querySelector('[name="keyword"]');if(n){let e;n.addEventListener("input",function(){clearTimeout(e),e=setTimeout(()=>{u=1,a=!0,H(new FormData(s),!0)},600)})}}),document.querySelectorAll('[id^="resetBtn"], .btn-filter-reset').forEach(s=>{s.addEventListener("click",function(l){l.preventDefault(),window.location.href="/courses"})})}function k(o){const s=new FormData(o),l=s.get("level_id"),n=s.get("category_id"),e=s.get("keyword");let t=null,r=null;if(l){const f=o.querySelector('[name="level_id"]');t=f.options[f.selectedIndex].dataset.slug}if(n){const f=o.querySelector('[name="category_id"]');r=f.options[f.selectedIndex].dataset.slug}u=1,a=!0;let c="/courses";n&&l&&r&&t?c=`/courses/category/${r}/level/${t}`:l&&t?c=`/courses/level/${t}`:n&&r?c=`/courses/category/${r}`:e&&(c=`/courses?keyword=${encodeURIComponent(e)}`),h=c,window.history.pushState({},"",c),S(c,!0)}function S(o,s=!0){if(i)return;i=!0,p(!0),s?P():E();const l=o.includes("?")?"&":"?",n=u>1?`${o}${l}page=${u}`:o;console.log("üåê AJAX Request URL:",n),fetch(n,{headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}).then(e=>e.json()).then(e=>{if(console.log("üì¶ Response:",{success:e.success,currentPage:e.currentPage,lastPage:e.lastPage,total:e.total,hasMore:e.hasMore}),!e.success){console.error("Failed to load courses"),i=!1,p(!1);return}u=e.currentPage,a=e.currentPage<e.lastPage,s?w(e.html,!0,e):w(e.html,!1,e),I(e),i=!1,p(!1)}).catch(e=>{console.error("‚ùå Error:",e),i=!1,p(!1),hideSkeletonLoader()})}function $(){const o=document.createElement("div");o.id="loadMoreContainer",o.className="text-center mt-5",o.innerHTML=`
            <button type="button" id="loadMoreBtn" class="btn btn-primary btn-lg px-5 py-3">
                <i class="fas fa-plus-circle me-2"></i>
                <span class="load-more-text">Load More Courses</span>
                <span class="load-more-count ms-2"></span>
            </button>
        `,b.appendChild(o),document.getElementById("loadMoreBtn").addEventListener("click",function(){console.log("üîò Load More clicked:",{isLoading:i,hasMorePages:a,currentPage:u,currentBaseUrl:h}),!i&&a?(u++,console.log("‚û°Ô∏è Loading page:",u),S(h,!1)):console.log("‚õî Cannot load more:",{isLoading:i,hasMorePages:a})}),T()}function T(){const o=document.getElementById("coursesContainer"),s=o?o.querySelector(".result-info"):null;if(console.log("üîç Checking initial pagination..."),s){const l=s.textContent,n=l.match(/Showing \d+-(\d+) of (\d+)/);if(console.log("üìù Result info text:",l),console.log("üî¢ Match:",n),n){const e=parseInt(n[1]),t=parseInt(n[2]);a=e<t,console.log("üìä Initial state:",{showing:e,total:t,hasMorePages:a});const r=document.getElementById("loadMoreContainer");if(r&&(r.style.display=a?"block":"none",a)){const c=t-e,f=Math.min(c,12),y=document.getElementById("loadMoreBtn");y&&(y.innerHTML=`
                                <i class="fas fa-plus-circle me-2"></i>
                                <span class="load-more-text">Load More Courses</span>
                                <span class="load-more-count ms-2">(${f} more)</span>
                            `)}}}}function R(){const o=document.querySelector(".btn-mobile-filter");o&&o.addEventListener("click",function(){this.classList.toggle("active")})}function p(o){[v,M].filter(l=>l).forEach(l=>{l.querySelectorAll("input, select, button").forEach(e=>{e.disabled=o,o?(e.style.opacity="0.6",e.style.cursor="not-allowed"):(e.style.opacity="",e.style.cursor="")})})}function H(o=null,s=!0){if(i)return;if(i=!0,p(!0),!o)if(Object.keys(m).length>0&&!s){o=new FormData;for(const[t,r]of Object.entries(m))r&&o.append(t,r)}else{const t=v||M;o=t?new FormData(t):new FormData}m=Object.fromEntries(o);const l=new URLSearchParams(m);l.set("page",u);const n=(v||M).getAttribute("data-url"),e=`${n}?${l.toString()}`;if(s&&u===1){const t=new URLSearchParams(m),r=t.toString()?`${n}?${t.toString()}`:n;window.history.pushState({},"",r)}console.log("üåê Request URL:",e),console.log("üìã Filters:",m),console.log("üìÑ Page:",u),s?P():E(),fetch(e,{headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}).then(t=>t.json()).then(t=>{if(console.log("üì¶ Response:",{success:t.success,hasMore:t.hasMore,currentPage:t.currentPage,lastPage:t.lastPage,total:t.total,coursesInResponse:t.html?"yes":"no"}),!t.success){console.error("Failed to load courses"),i=!1,p(!1);return}if(a=t.currentPage<t.lastPage,console.log("üìä State after update:",{hasMorePages:a,currentPage:u,lastPage:t.lastPage,total:t.total,calculation:`${t.currentPage} < ${t.lastPage} = ${a}`}),s?w(t.html,!0,t):w(t.html,!1,t),I(t),s){const r=e.replace("&page=1","").replace("page=1&","").replace("?page=1","");window.history.pushState({},"",r||e)}i=!1,p(!1)}).catch(t=>{console.error("Error:",t),L(),i=!1,p(!1)})}function w(o,s,l){const n=document.createElement("div");n.innerHTML=o;const e=n.querySelector(".row.g-4");if(s)d.style.opacity="0",d.style.transition="opacity 0.3s",setTimeout(()=>{const t=d.querySelector(".row.g-4");t&&e&&(t.innerHTML=e.innerHTML);const r=n.querySelector(".result-info"),c=d.querySelector(".result-info");r&&c?c.outerHTML=r.outerHTML:r&&d.insertBefore(r,d.firstChild),d.style.opacity="1",L(),b.scrollIntoView({behavior:"smooth",block:"start"})},300);else{const t=d.querySelector(".row.g-4");if(t&&e){const c=e.querySelectorAll(".col-lg-4");if(c.length===0){console.log("No new courses to append"),L();return}const f=new Set;t.querySelectorAll("a[href]").forEach(g=>{f.add(g.getAttribute("href"))});let y=0;c.forEach((g,U)=>{const B=g.querySelector("a[href]"),C=B?B.getAttribute("href"):null;C&&f.has(C)||(g.style.opacity="0",g.style.transform="translateY(20px)",t.appendChild(g),y++,setTimeout(()=>{g.style.transition="all 0.5s ease",g.style.opacity="1",g.style.transform="translateY(0)"},100+y*50))})}const r=d.querySelector(".result-info h5");if(r&&l){const c=t.querySelectorAll(".col-lg-4").length;r.innerHTML=`
                    <i class="fas fa-graduation-cap"></i>
                    Showing 1-${c} of ${l.total} courses
                `}L()}}function P(){const o=d.querySelector(".row.g-4");o&&(o.innerHTML=Array(6).fill(0).map(()=>`
                <div class="col-lg-4 col-md-6">
                    <div class="course-card-skeleton">
                        <div class="skeleton skeleton-img"></div>
                        <div class="skeleton-body">
                            <div class="skeleton skeleton-badge"></div>
                            <div class="skeleton skeleton-title"></div>
                            <div class="skeleton skeleton-text"></div>
                            <div class="skeleton skeleton-text"></div>
                            <div class="skeleton skeleton-button"></div>
                        </div>
                    </div>
                </div>
            `).join(""))}function I(o){const s=document.getElementById("loadMoreContainer"),l=document.getElementById("loadMoreBtn");if(!s||!l)return;const n=o.currentPage<o.lastPage;if(console.log("üîÑ Update button:",{currentPage:o.currentPage,lastPage:o.lastPage,total:o.total,actuallyHasMore:n}),n){s.style.display="block",s.className="text-center mt-5";const e=o.currentPage*12,t=o.total-e,r=Math.min(t,12);l.disabled=!1,l.innerHTML=`
                <i class="fas fa-plus-circle me-2"></i>
                <span class="load-more-text">Load More Courses</span>
                <span class="load-more-count ms-2">(${r} more)</span>
            `}else s.style.display="block",s.className="text-center mt-5",s.innerHTML=`
                <div class="end-of-results">
                    <div class="end-icon mb-3">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h5 class="mb-2">You've reached the end!</h5>
                    <p class="text-muted mb-0">You've viewed all ${o.total||0} available courses</p>
                </div>
            `}function E(){const o=document.getElementById("loadMoreBtn");o&&(o.disabled=!0,o.innerHTML=`
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                Loading...
            `)}function L(){const o=document.getElementById("load-more-spinner");o&&o.remove()}});
